services:
  postgres:
    image: postgres:17-alpine
    container_name: ocr-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 12345678
      POSTGRES_MULTIPLE_DATABASES: "ocr_db,norma_db"
    volumes:
      - ./infrastructure/postgres/data:/var/lib/postgresql/17/data
      - ./infrastructure/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - network
    restart: unless-stopped

  kafka:
    image: bitnamilegacy/kafka:4.0.0-debian-12-r10
    container_name: ocr-kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - network
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: ocr-minio
    environment:
      MINIO_ROOT_USER: ocrminio
      MINIO_ROOT_PASSWORD: admin123456
      MINIO_BROWSER: "on"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s

  minio-init:
    image: minio/mc:latest
    container_name: ocr-minio-init
    depends_on:
      - minio
    networks:
      - network
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO to start...';
      until nc -z minio 9000; do sleep 2; done;
      sleep 5;
      mc alias set localminio http://minio:9000 ocrminio admin123456;
      mc mb localminio/documents --ignore-existing;
      mc mb localminio/templates --ignore-existing;
      mc anonymous set download localminio/documents;
      mc anonymous set none localminio/templates;
      mc admin user add localminio appuser apppassword123;
      cat > /tmp/readwrite.json << 'EOF'
      {
        \"Version\": \"2012-10-17\",
        \"Statement\": [
          {
            \"Effect\": \"Allow\",
            \"Action\": [
              \"s3:GetObject\",
              \"s3:PutObject\",
              \"s3:DeleteObject\",
              \"s3:ListBucket\"
            ],
            \"Resource\": [
              \"arn:aws:s3:::documents/*\",
              \"arn:aws:s3:::templates/*\"
            ]
          }
        ]
      }
      EOF
      mc admin policy create localminio readwrite /tmp/readwrite.json;
      mc admin policy attach localminio readwrite --user=appuser;
      "
    restart: "no"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: ocr-kafka-ui
    environment:
      KAFKA_CLUSTERS_0_NAME: ocr-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    ports:
      - "8080:8080"
    depends_on:
      - kafka
    networks:
      - network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: ocr-nginx
    ports:
      - "80:80"
    volumes:
      - ./infrastructure/nginx/nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - minio
      - kafka-ui
    networks:
      - network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ocr-redis
    ports:
      - "6379:6379"
    command: redis-server --requirepass redis123
    volumes:
      - redis_data:/data
    networks:
      - network
    restart: unless-stopped

  pdf-processor:
    build:
      context: ./services/pdf_processor/src
      dockerfile: Dockerfile
    container_name: ocr-pdf-processor
    ports:
      - "8000:8000"
    networks:
      - network
    volumes:
      - ./services/pdf_processor/src:/app
      - ./services/pdf_processor/src/logs:/app/logs
    depends_on:
      - minio
      - nginx
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: ocr-sheduler-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "
      ollama start &
      sleep 10
      ollama pull deepseek-ocr
      tail -f /dev/null
      "
    networks:
      - network

  ocr-worker:
    build: ./services/ocr_worker/
    container_name: ocr-worker
    depends_on:
      - minio
      - ollama
    volumes:
      - ./service/ocr_worker/results:/app/results
    networks:
      - network
    restart: unless-stopped

volumes:
  postgres_data:
  kafka_data:
  minio_data:
  redis_data:
  ollama_data:

networks:
  network: